var x=Symbol(),k=Symbol(),D=Symbol(),F=Symbol(),B=Symbol(),E=Symbol(),j=Symbol(),N=Symbol(),A=Symbol(),Q=Symbol(),Pe=()=>{let e={[x]:{},[k]:{},[D]:{},[F]:{},[E]:!0,[B]:{},[j]:[],[Q]:null,time:{elapsed:0,elapsedScaled:0,delta:0,scale:1,fps:0},[N]:!1,[A]:[]},n=o=>{e[Q]=o},a=()=>{let o=0,s=0,i=w.bind(a),g=-1,{time:d}=e;d.delta=0,d.elapsed=0,d.elapsedScaled=0,d.fps=0,e[N]=!0;let K=null,M=null;if(typeof window<"u")K=requestAnimationFrame,M=cancelAnimationFrame;else{let y=0;K=c=>setTimeout(()=>{y+=16.67,c(y)},16.67),M=c=>{clearTimeout(c)}}let l=100/60;function w(y){if(!e[N])return M(g);if(d.delta=y-o,d.elapsedScaled+=d.delta*.001*d.scale,d.elapsedScaled<d.elapsed)return K(i);d.elapsed+=d.delta*.001,o=y,s+=d.delta,s>100&&(d.fps=Math.ceil(1e3/d.delta*l*100)/100,s=0),e[Q](),g=K(i)}return g=K(i),()=>e[N]=!1},b=()=>{e[N]=!1},f=(...o)=>()=>{for(let s of o)s(e)},r=(...o)=>f(...o);function p(){for(let o of e[j])o(e)}function v(...o){for(let s of o)if(typeof s=="function")e[j].push(s);else if(s.update&&typeof s.update=="function")e[j].push(s.update);else throw new Error(`Not a valid system: ${JSON.stringify(s)}`)}function h(...o){for(let s of o)if(typeof s=="function")e[j]=e[j].filter(i=>i!==s);else if(s.update&&typeof s.update=="function")e[j]=e[j].filter(i=>i!==s.update);else throw new TypeError("Parameter must be a function or an object with an update function.")}let _=(o,s)=>{if(!e[E]&&e[B][s])return e[B][s];let{and:i=[],or:g=[],not:d=[],tag:K=[]}=o,M=new Set;Object.values(e[F]).forEach(w=>{let y=[];d.length&&y.push(!d.some(c=>w.hasComponent(c))),i.length&&y.push(i.every(c=>w.hasComponent(c))),g.length&&y.push(g.some(c=>w.hasComponent(c))),K.length&&y.push(K.some(c=>w.tag&&w.tag===c)),y.length&&y.every(c=>c===!0)&&M.add(w.id)});let l=[];return[...M].map(w=>l.push(e[F][w])),e[B][s]=l,e[E]=!1,l},Le=o=>{let{and:s=[],or:i=[],not:g=[],tag:d=[]}=o,K=l=>Object.prototype.hasOwnProperty.call(l,"name");if(![...s,...i,...g].every(K))throw new Error("Invalid query");let M=["and",...s.map(l=>l.name),"or",...i.map(l=>l.name),"not",...g.map(l=>l.name),"tag",...d].join("");return l=>l(_(o,M))};function Ee(o){if(!e[F][o.id])return!1;let i=[];return e[x][o.id].forEach(g=>{i.push(g)}),i.forEach(g=>{e[D][g]=e[D][g].filter(d=>d!==o.id)}),delete e[x][o.id],delete e[F][o.id],e[E]=!0,!0}function ke(o){if(typeof o=="function")return e[A].push(o),()=>{e[A]=e[A].filter(s=>s!==o)}}function De(o,s,i={}){return e[E]=!0,e[x]?.[o.id]?.has(s.name)||(i&&typeof i=="object"?o.components.push(Object.assign(s(),i)):o.components.push(s()),e[x][o.id]=e[x][o.id]||new Set,e[x][o.id].add(s.name),e[k][o.id]=e[k][o.id]||{},e[k][o.id][s.name]=o.components.length-1,e[D][s.name]=e[D][s.name]||[],e[D][s.name].push(o.id)),o}let je=0;function Fe(o={}){e[E]=!0;let s=je++,i=[];function g(m){return this.tag=m,e[E]=!0,this}function d(){return this.tag="",e[E]=!0,this}function K(){return this.tag}function M(m,L={}){return De(this,m,L)}function l(m){return e[x]?.[s]?.has(m.name)}function w(m){let L=[...e[x][s]].indexOf(m.name);return i[L]}function y(m){return e[x][s].delete(m.name),e[k][s][m.name]=void 0,e[D][m.name]=e[D][m.name].filter(L=>L!==s),i.splice([...e[x][s]].indexOf(m.name)-1,1),Object.keys(e[k][s]).forEach(L=>{e[k][s][L]>i.findIndex(Re=>Re.name===L)&&e[k][s][L]--}),e[E]=!0,this}function c(){return Ee(this)}let q=Object.assign({},o,{id:s,components:i,addTag:g,removeTag:d,getTag:K,addComponent:M,hasComponent:l,getComponent:w,removeComponent:y,destroy:c});return e[F][s]=q,e[x][s]=new Set,e[A].forEach(m=>{m(q)}),q}return{world:e,query:Le,createEntity:Fe,onEntityCreated:ke,addSystem:v,removeSystem:h,start:a,stop:b,step:p,pipe:r,defineMain:n}};var X=()=>({axes:{0:"MoveHorizontal",1:"MoveVertical",2:"LookHorizontal",3:"LookVertical"},buttons:{0:"X",1:"O",2:"Square",3:"Triangle",4:"L1",5:"R1",6:"L2",7:"R2",8:"Select",9:"Start",10:"LeftStick",11:"RightStick",12:"AnalogUp",13:"AnalogDown",14:"AnalogLeft",15:"AnalogRight",16:"Dashboard",17:"Touchpad"}});var ee=()=>X(),z=()=>({axes:{0:"MoveHorizontal",1:"MoveVertical",2:"LookHorizontal",3:"LookVertical"},buttons:{0:"A",1:"B",2:"X",3:"Y",4:"LB",5:"RB",6:"LT",7:"RT",8:"Back",9:"Start",10:"LeftStick",11:"RightStick",12:"AnalogUp",13:"AnalogDown",14:"AnalogLeft",15:"AnalogRight",16:"Guide",17:"Touchpad"}});var C={},S={axes:{0:0,1:0,2:0,3:0},buttons:{}};var R={},te=.055,$=e=>Math.abs(e)>=te?e:Math.abs(e)<te?0:1,ne=()=>{for(let e of navigator.getGamepads())if(e){S[e.index]={axes:{0:$(e.axes[0]),1:$(e.axes[1]),2:$(e.axes[2]),3:$(e.axes[3])},buttons:{}};for(let[n,a]of Object.entries(e.buttons))S[e.index].buttons[n]={pressed:a.pressed,touched:a.touched,value:a.value,justPressed:a.pressed&&!R?.[e.index]?.buttons?.[n]?.pressed&&!R?.[e.index]?.buttons?.[n]?.justPressed,justReleased:!a.pressed&&R?.[e.index]?.buttons?.[n]?.pressed};for(let[n,a]of Object.entries(S[e.index]?.buttons))R[e.index].buttons[n]={...a,justPressed:!1}}},se=()=>({gamepad(e){return C[e]||Ne(navigator.getGamepads()[e]),{useMapping:n=>C[e]=n(),getButton(n){if(!S[e])return{pressed:!1,touched:!1,value:0,justPressed:!1,justReleased:!1};let a=Object.keys(C[e].buttons)[Object.values(C[e].buttons).indexOf(n)];return S[e].buttons[a]?S[e].buttons[a]:{pressed:!1,touched:!1,value:0,justPressed:!1,justReleased:!1}},getAxis(n){if(!S[e])return 0;let a=Object.keys(C[e].axes)[Object.values(C[e].axes).indexOf(n)];return S[e].axes[a]?S[e].axes[a]:0}}}}),Ne=e=>{e&&(e.id.toLowerCase().includes("sony")||e.id.toLowerCase().includes("playstation")?C[e.index]=ee():e.id.toLowerCase().includes("xbox")?C[e.index]=z():e.id.toLowerCase().includes("scuf")?C[e.index]=X():(console.warn(`couldn't reasonably find a mapping for controller with id ${e.id} - defaulting to xbox mapping.`),C[e.index]=z()))},Ae=e=>{S[e]={axes:{},buttons:{}},R[e]={axes:{},buttons:{}}},oe=e=>{Ae(e.gamepad.index)},re=e=>{delete S[e.gamepad.index],delete R[e.gamepad.index]};var Y=(t=>(t.KeyQ="KeyQ",t.KeyW="KeyW",t.KeyE="KeyE",t.KeyR="KeyR",t.KeyT="KeyT",t.KeyY="KeyY",t.KeyU="KeyU",t.KeyI="KeyI",t.KeyO="KeyO",t.KeyP="KeyP",t.KeyA="KeyA",t.KeyS="KeyS",t.KeyD="KeyD",t.KeyF="KeyF",t.KeyG="KeyG",t.KeyH="KeyH",t.KeyJ="KeyJ",t.KeyK="KeyK",t.KeyL="KeyL",t.KeyZ="KeyZ",t.KeyX="KeyX",t.KeyC="KeyC",t.KeyV="KeyV",t.KeyB="KeyB",t.KeyN="KeyN",t.KeyM="KeyM",t.BracketLeft="BracketLeft",t.BracketRight="BracketRight",t.Comma="Comma",t.Period="Period",t.Slash="Slash",t.Backquote="Backquote",t.Semicolon="Semicolon",t.Quote="Quote",t.Backslash="Backslash",t.IntlBackslash="IntlBackslash",t.Digit1="Digit1",t.Digit2="Digit2",t.Digit3="Digit3",t.Digit4="Digit4",t.Digit5="Digit5",t.Digit6="Digit6",t.Digit7="Digit7",t.Digit8="Digit8",t.Digit9="Digit9",t.Digit0="Digit0",t.Minus="Minus",t.Equal="Equal",t.Enter="Enter",t.Space="Space",t.NumpadDecimal="NumpadDecimal",t.Numpad0="Numpad0",t.Numpad1="Numpad1",t.Numpad2="Numpad2",t.Numpad3="Numpad3",t.Numpad4="Numpad4",t.Numpad5="Numpad5",t.Numpad6="Numpad6",t.Numpad7="Numpad7",t.Numpad8="Numpad8",t.Numpad9="Numpad9",t.NumpadDivide="NumpadDivide",t.NumpadMultiply="NumpadMultiply",t.NumpadSubtract="NumpadSubtract",t.NumpadAdd="NumpadAdd",t.NumpadEnter="NumpadEnter",t.Delete="Delete",t.End="End",t.Home="Home",t.Insert="Insert",t.PageDown="PageDown",t.PageUp="PageUp",t.ArrowDown="ArrowDown",t.ArrowLeft="ArrowLeft",t.ArrowRight="ArrowRight",t.ArrowUp="ArrowUp",t.Backspace="Backspace",t.AltLeft="AltLeft",t.AltRight="AltRight",t.CapsLock="CapsLock",t.ContextMenu="ContextMenu",t.ControlLeft="ControlLeft",t.ControlRight="ControlRight",t.ShiftLeft="ShiftLeft",t.ShiftRight="ShiftRight",t.Tab="Tab",t.Escape="Escape",t.F1="F1",t.F2="F2",t.F3="F3",t.F4="F4",t.F5="F5",t.F6="F6",t.F7="F7",t.F8="F8",t.F9="F9",t.F10="F10",t.F11="F11",t.F12="F12",t.PrintScreen="PrintScreen",t.ScrollLock="ScrollLock",t.Pause="Pause",t))(Y||{}),ae=()=>({["KeyW"]:"Forward",["KeyA"]:"Left",["KeyS"]:"Back",["KeyD"]:"Right",["KeyQ"]:"Quickswitch",["KeyE"]:"Use",["KeyR"]:"Reload",["KeyY"]:"ChatAll",["KeyU"]:"ChatTeam",["Tab"]:"Scoreboard",["ControlLeft"]:"Crouch",["Space"]:"Jump",["ShiftLeft"]:"Sprint"});var J=ae(),O={keys:{}},G={keys:{}},ie={keys:{}},de=()=>({keyboard:{useMapping:e=>J=e(),getKey(e){let n=Object.keys(J)[Object.values(J).indexOf(e)];return n?O.keys[n]:O.keys[e]?O.keys[e]:{pressed:!1,justPressed:!1,justReleased:!1}}}}),ue=()=>{for(let[e,n]of Object.entries(G.keys))O.keys[e]={...n,justReleased:!n.pressed&&ie.keys?.[e]?.pressed},ie.keys[e]={...n,justPressed:!1},G.keys[e]={...n,justPressed:!1}},pe=()=>{for(let e of Object.values(Y))O.keys[e]={pressed:!1,justPressed:!1,justReleased:!1}},le=e=>{e.repeat||(G.keys[e.code]={pressed:!0,justPressed:!0,justReleased:!1})},ge=e=>{G.keys[e.code]={pressed:!1,justPressed:!1,justReleased:!0}};var Z=(r=>(r.Mouse1="0",r.Mouse2="2",r.Mouse3="1",r.Mouse4="3",r.Mouse5="4",r))(Z||{}),ce=()=>({axes:{0:"Horizontal",1:"Vertical",2:"Wheel"},buttons:{0:"Mouse1",1:"Mouse3",2:"Mouse2",3:"Mouse4",4:"Mouse5"}});var T=ce(),me=null,u={axes:{},buttons:{},position:[0,0]},V={buttons:{}},ye={buttons:{}},fe=()=>{for(let[e,n]of Object.entries(V.buttons))u.buttons[e]={...n,justReleased:!n.pressed&&ye.buttons?.[e]?.pressed},ye.buttons[e]={...n,justPressed:!1},V.buttons[e]={...n,justPressed:!1}},W={},U={},be=()=>({mouse:{useMapping:e=>{T=e(),W={},U={}},getButton(e){if(W[e])return u.buttons[W[e]];let n=Object.keys(T.buttons)[Object.values(T.buttons).indexOf(e)];return n?(W[e]=n,u.buttons[n]):u.buttons[e]?u.buttons[e]:{pressed:!1,justPressed:!1,justReleased:!1}},getAxis(e){if(U[e])return u.axes[U[e]];let n=Object.keys(T.axes)[Object.values(T.axes).indexOf(e)];return n?(U[e]=n,u.axes[n]):u.axes[e]?u.axes[e]:0},getPosition(){return u.position}}}),he=()=>{u.axes={0:0,1:0,2:0};for(let e of Object.values(Z))u.buttons[e]={pressed:!1,justPressed:!1,justReleased:!1}};var Ke=e=>{clearTimeout(me),me=setTimeout(()=>{u.axes[0]=0,u.axes[1]=0,u.axes[2]=0},30),u.axes[0]=e.movementX,u.axes[1]=e.movementY,u.position[0]=e.clientX,u.position[1]=e.clientY},we=e=>{V.buttons[e.button]={pressed:!0,justPressed:!0,justReleased:!1}},xe=e=>{V.buttons[e.button]={pressed:!1,justPressed:!1,justReleased:!0}},Se=e=>{u.axes[2]=e.deltaY,requestAnimationFrame(()=>{u.axes[2]=0})};var Oe=null,Te=null,Be=null,$e=null,Ge=null,We=null,Ue=null,Ve=null,ve=!1,He=()=>{pe(),he()},Ie=e=>(typeof window>"u"||(ve||(qe(),He(),ve=!0),fe(),ue(),ne()),e);var qe=()=>{Oe=window.addEventListener("mousemove",Ke),Te=window.addEventListener("mousedown",we),Be=window.addEventListener("mouseup",xe),$e=window.addEventListener("mousewheel",Se),Ge=window.addEventListener("keydown",le),We=window.addEventListener("keyup",ge),Ue=window.addEventListener("gamepadconnected",oe),Ve=window.addEventListener("gamepaddisconnected",re)};var Qe={...de(),...be(),...se()};var H=e=>{let n=document.createElement("canvas"),{target:a,fullscreen:b}=e,{body:f}=window.document;a&&b?e.target=null:!a&&!b&&(e.fullscreen=!0),n.width=n.offsetWidth,n.height=n.offsetHeight,n.style.width="100%",n.style.height="100%",b&&(n.style.position="absolute",n.style.top="0",n.style.left="0",n.width=window.innerWidth,n.height=window.innerHeight,f.appendChild(n),f.style.margin="0",f.style.padding="0",f.style.width="100%",f.style.height="100%",f.style.overflow="hidden"),a&&(a.appendChild(n),a.style.overflow="hidden",n.width=n.offsetWidth,n.height=n.offsetHeight);let r=window.document.createElement("meta");return r.name="viewport",r.content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0",window.document.head.appendChild(r),n};var Me=e=>~~(.5+e),P=e=>({x:Me(e.x),y:Me(e.y)}),I=e=>({text:(r,p,v="gray",h=16)=>{r=P(r),e.save(),e.fillStyle=v,e.font=`${h}px sans-serif`,e.fillText(p,r.x,r.y),e.restore()},line:(r,p,v="gray",h=1)=>{r=P(r),p=P(p),e.save(),e.beginPath(),e.moveTo(r.x,r.y),e.lineTo(p.x,p.y),e.lineWidth=h,e.stroke(),e.closePath(),e.restore()},rectangle:(r,p,v="gray",h=1)=>{r=P(r),p=P(p),e.save(),e.beginPath(),e.rect(r.x,r.y,p.x,p.y),e.lineWidth=h,e.strokeStyle=v,e.stroke(),e.closePath(),e.restore()},circle:(r,p=25,v="gray",h=1)=>{r=P(r),e.save(),e.beginPath(),e.strokeStyle=v,e.lineWidth=h,e.arc(r.x,r.y,p,0,Math.PI*2,!0),e.stroke(),e.closePath(),e.restore()}});var Ce=e=>{let{width:n=800,height:a=600,fullscreen:b=!1,target:f=null}=e.canvas,r=H({width:n,height:a,fullscreen:b,target:f}),p=r.getContext("2d"),v=I(p),h=()=>{if(b){r.style.width="100%",r.style.height="100%",r.width=window.innerWidth,r.height=window.innerHeight;return}r.width=r.offsetWidth,r.height=r.offsetHeight};return window.addEventListener("resize",h),{canvas:r,context:p,draw:v,destroy:()=>{window.removeEventListener("resize",h),r.parentElement.removeChild(r)}}};var Xe=256,ze=(e={maxLifetime:1e4})=>{let n={expiringLogs:[],allLogs:[],update(a){this.expiringLogs.length&&this.expiringLogs.forEach((b,f)=>{b.lifetime-=a.time.delta,b.lifetime<0&&this.expiringLogs.splice(f,1)})},log(a){this.expiringLogs.push({message:a,lifetime:e.maxLifetime,start:new Date}),this.allLogs.push({message:a})}};return n.update=n.update.bind(n),n.log=n.log.bind(n),n.allLogs.push=function(){return this.length>=Xe&&this.shift(),Array.prototype.push.apply(this,arguments)},n};export{Ce as create2D,H as createCanvas,I as createDraw,ze as createLogSystem,Pe as createWorld,Qe as input,Ie as inputSystem};
