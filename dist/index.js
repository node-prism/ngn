var m=Symbol(),C=Symbol(),x=Symbol(),G=Symbol(),W=Symbol(),S=Symbol(),M=Symbol(),A=Symbol(),N=Symbol(),Y=Symbol(),$e=()=>{let e={[m]:{},[C]:{},[x]:{},[W]:new Set,[S]:new Map,[G]:{},[M]:[],[Y]:null,time:{elapsed:0,elapsedScaled:0,delta:0,scale:1,fps:0},[A]:!1,[N]:[]},t=n=>{e[Y]=n},a=()=>{let n=0,s=0,r=b.bind(a),d=-1,{time:i}=e;i.delta=0,i.elapsed=0,i.elapsedScaled=0,i.fps=0,e[A]=!0;let f=null,u=null;if(typeof window<"u")f=requestAnimationFrame,u=cancelAnimationFrame;else{let g=0;f=R=>setTimeout(()=>{g+=16.67,R(g)},16.67),u=R=>{clearTimeout(R)}}function b(g){if(!e[A])return u(d);if(i.delta=g-n,i.elapsedScaled+=i.delta*.001*i.scale,i.elapsedScaled<i.elapsed)return f(r);i.elapsed+=i.delta*.001,n=g,s+=i.delta,s>100&&(i.fps=Math.min(Math.ceil(1e3/i.delta/(1e3/60)),60),s=0),e[Y](),d=f(r)}return d=f(r),()=>e[A]=!1},y=()=>{e[A]=!1},w=(...n)=>()=>{for(let s of n)s(e)},o=(...n)=>w(...n);function l(){for(let n of e[M])n(e)}function E(...n){for(let s of n)if(typeof s=="function")e[M].push(s);else if(s.update&&typeof s.update=="function")e[M].push(s.update);else throw new Error(`Not a valid system: ${JSON.stringify(s)}`)}function K(...n){for(let s of n)if(typeof s=="function")e[M]=e[M].filter(r=>r!==s);else if(s.update&&typeof s.update=="function")e[M]=e[M].filter(r=>r!==s.update);else throw new TypeError("Parameter must be a function or an object with an update function.")}let ne=(n,s)=>{if(!e[W].has(s)&&e[G][s])return e[G][s];let{and:r=[],or:d=[],not:i=[],tag:f=[]}=n,u=Object.values(e[x]).filter(b=>(!i.length||!i.some(g=>b.hasComponent(g)))&&(!r.length||r.every(g=>b.hasComponent(g)))&&(!d.length||d.some(g=>b.hasComponent(g)))&&(!f.length||f.some(g=>b.tag===g)));return e[G][s]=u,e[W].delete(s),u},L=n=>{e[W].add(n)},Le=({and:n=[],or:s=[],not:r=[],tag:d=[]})=>{let i=u=>Object.prototype.hasOwnProperty.call(u,"name");if(![...n,...s,...r].every(i))throw new Error("Invalid query");let f=["and",...n.map(u=>u.name),"or",...s.map(u=>u.name),"not",...r.map(u=>u.name),"tag",...d].join("");return[...n,...s,...r].forEach(u=>{let b=e[S].get(u.name)||new Set;b.add(f),e[S].set(u.name,b)}),d.forEach(u=>{let b=`tag:${u}`,g=e[S].get(b)||new Set;g.add(f),e[S].set(b,g)}),u=>u(ne({and:n,or:s,not:r,tag:d},f))};function De(n){if(!e[x][n.id])return!1;let r=Object.keys(e[m][n.id]);return r.forEach(d=>{e[C][d]=e[C][d].filter(i=>i!==n.id)}),delete e[m][n.id],delete e[x][n.id],r.forEach(d=>{let i=e[S].get(d);i&&i.forEach(L)}),!0}function je(n){if(typeof n=="function")return e[N].push(n),()=>{e[N]=e[N].filter(s=>s!==n)}}function Fe(n,s,r={}){if(e[m]?.[n.id]?.[s.name]!==void 0)return n;let d=e[S].get(s.name);return d&&d.forEach(L),n.components.push(Object.assign({},{...s(),...r,__ngn__:{parent:n.id,name:s.name}})),e[m][n.id]=e[m][n.id]||{},e[m][n.id][s.name]=n.components.length-1,e[C][s.name]=e[C][s.name]||[],e[C][s.name].push(n.id),n}let B=0,se=()=>{for(;e[x][B];)B++;return B};function Re(n={},s=void 0){let r=s??se(),d=[];s!==void 0&&(B=s);let i=c=>`tag:${c}`;function f(c){let h=i(this.tag);this.tag=c;let T=e[S].get(i(c));T&&T.forEach(L);let $=e[S].get(h);return $&&$.forEach(L),this}function u(){let c=i(this.tag);this.tag="";let h=e[S].get(c);return h&&h.forEach(L),this}function b(){return this.tag}function g(c,h={}){return Fe(this,c,h)}function R(c){return e[m]?.[r]?.[c.name]!==void 0}function Ae(c){let h=e[m][r][c.name];return d[h]}function Ne(c){let h=typeof c=="string"?c:c.name,T=e[S].get(h);T&&T.forEach(L),e[m][r][h]=void 0,e[C][h]=e[C][h].filter(P=>P!==r);let $=e[m][r][h];return d.splice($,1),Object.keys(e[m][r]).forEach(P=>{e[m][r][P]>d.findIndex(Be=>Be.name===P)&&e[m][r][P]--}),this}function Oe(){return De(this)}let z=Object.assign({},n,{id:r,components:d,addTag:f,removeTag:u,getTag:b,addComponent:g,hasComponent:R,getComponent:Ae,removeComponent:Ne,destroy:Oe});return s!==void 0&&e[x][s]&&Te(s,se()),e[x][r]=z,e[m][r]={},e[N].forEach(c=>{c(z)}),z}function Te(n,s){let r=e[x][n];r&&(r.id=s,e[x][s]=r,delete e[x][n],e[m][s]=e[m][n],delete e[m][n])}function Pe(n){return e[x][n]}return{world:e,query:Le,createEntity:Re,getEntity:Pe,onEntityCreated:je,addSystem:E,removeSystem:K,start:a,stop:y,step:l,pipe:o,defineMain:t}};var J=()=>({axes:{0:"MoveHorizontal",1:"MoveVertical",2:"LookHorizontal",3:"LookVertical"},buttons:{0:"X",1:"O",2:"Square",3:"Triangle",4:"L1",5:"R1",6:"L2",7:"R2",8:"Select",9:"Start",10:"LeftStick",11:"RightStick",12:"AnalogUp",13:"AnalogDown",14:"AnalogLeft",15:"AnalogRight",16:"Dashboard",17:"Touchpad"}});var oe=()=>J(),Z=()=>({axes:{0:"MoveHorizontal",1:"MoveVertical",2:"LookHorizontal",3:"LookVertical"},buttons:{0:"A",1:"B",2:"X",3:"Y",4:"LB",5:"RB",6:"LT",7:"RT",8:"Back",9:"Start",10:"LeftStick",11:"RightStick",12:"AnalogUp",13:"AnalogDown",14:"AnalogLeft",15:"AnalogRight",16:"Guide",17:"Touchpad"}});var k={},v={axes:{0:0,1:0,2:0,3:0},buttons:{}},D={},re=.055,U=e=>Math.abs(e)>=re?e:Math.abs(e)<re?0:1,ae=()=>{for(let e of navigator.getGamepads())if(e){v[e.index]={axes:{0:U(e.axes[0]),1:U(e.axes[1]),2:U(e.axes[2]),3:U(e.axes[3])},buttons:{}};for(let[t,a]of Object.entries(e.buttons))v[e.index].buttons[t]={pressed:a.pressed,touched:a.touched,value:a.value,justPressed:a.pressed&&!D?.[e.index]?.buttons?.[t]?.pressed&&!D?.[e.index]?.buttons?.[t]?.justPressed,justReleased:!a.pressed&&D?.[e.index]?.buttons?.[t]?.pressed};for(let[t,a]of Object.entries(v[e.index]?.buttons))D[e.index].buttons[t]={...a,justPressed:!1}}},ie=()=>({gamepad(e){return k[e]||Ge(navigator.getGamepads()[e]),{useMapping:t=>k[e]=t(),getButton(t){if(!v[e])return{pressed:!1,touched:!1,value:0,justPressed:!1,justReleased:!1};let a=Object.keys(k[e].buttons)[Object.values(k[e].buttons).indexOf(t)];return v[e].buttons[a]?v[e].buttons[a]:{pressed:!1,touched:!1,value:0,justPressed:!1,justReleased:!1}},getAxis(t){if(!v[e])return 0;let a=Object.keys(k[e].axes)[Object.values(k[e].axes).indexOf(t)];return v[e].axes[a]?v[e].axes[a]:0}}}}),Ge=e=>{if(!e)return;let t=e.id.toLowerCase(),y=[{ids:["sony","playstation"],mapping:oe},{ids:["xbox"],mapping:Z},{ids:["scuf"],mapping:J}].find(w=>w.ids.some(o=>t.includes(o)));y?k[e.index]=y.mapping():(console.warn(`couldn't reasonably find a mapping for controller with id ${e.id} - defaulting to xbox mapping.`),k[e.index]=Z())},We=e=>{v[e]={axes:{},buttons:{}},D[e]={axes:{},buttons:{}}},de=e=>{We(e.gamepad.index)},ue=e=>{delete v[e.gamepad.index],delete D[e.gamepad.index]};var pe=()=>({["KeyW"]:"Forward",["KeyA"]:"Left",["KeyS"]:"Back",["KeyD"]:"Right",["KeyQ"]:"Quickswitch",["KeyE"]:"Use",["KeyR"]:"Reload",["KeyY"]:"ChatAll",["KeyU"]:"ChatTeam",["Tab"]:"Scoreboard",["ControlLeft"]:"Crouch",["Space"]:"Jump",["ShiftLeft"]:"Sprint"});var Q=pe(),O={keys:{}},V={keys:{}},le={keys:{}},ge=()=>({keyboard:{useMapping:e=>{Q=e(),ee()},getKey(e){let t=Object.keys(Q)[Object.values(Q).indexOf(e)];return t?O.keys[t]:O.keys[e]?O.keys[e]:{pressed:!1,justPressed:!1,justReleased:!1}}}}),ce=()=>{for(let[e,t]of Object.entries(V.keys))O.keys[e]={...t,justReleased:!t.pressed&&le.keys?.[e]?.pressed},le.keys[e]={...t,justPressed:!1},V.keys[e]={...t,justPressed:!1}},ee=()=>{for(let e of Object.keys(Q))O.keys[e]={pressed:!1,justPressed:!1,justReleased:!1}},me=e=>{e.repeat||(V.keys[e.code]={pressed:!0,justPressed:!0,justReleased:!1})},ye=e=>{V.keys[e.code]={pressed:!1,justPressed:!1,justReleased:!0}};var fe=()=>({axes:{0:"Horizontal",1:"Vertical",2:"Wheel"},buttons:{0:"Mouse1",1:"Mouse3",2:"Mouse2",3:"Mouse4",4:"Mouse5"}});var j=fe(),be=null,p={axes:{},buttons:{},position:[0,0]},I={buttons:{}},he={buttons:{}},Ke=()=>{for(let[e,t]of Object.entries(I.buttons))p.buttons[e]={...t,justReleased:!t.pressed&&he.buttons?.[e]?.pressed},he.buttons[e]={...t,justPressed:!1},I.buttons[e]={...t,justPressed:!1}},H={},q={},we=()=>({mouse:{useMapping:e=>{j=e(),H={},q={},te()},getButton(e){if(H[e])return p.buttons[H[e]];let t=Object.keys(j.buttons)[Object.values(j.buttons).indexOf(e)];return t?(H[e]=t,p.buttons[t]):p.buttons[e]?p.buttons[e]:{pressed:!1,justPressed:!1,justReleased:!1}},getAxis(e){if(q[e])return p.axes[q[e]];let t=Object.keys(j.axes)[Object.values(j.axes).indexOf(e)];return t?(q[e]=t,p.axes[t]):p.axes[e]?p.axes[e]:0},getPosition(){return p.position}}}),te=()=>{p.axes={0:0,1:0,2:0};for(let e of Object.keys(j.buttons))p.buttons[e]={pressed:!1,justPressed:!1,justReleased:!1}};var xe=e=>{clearTimeout(be),be=setTimeout(()=>{p.axes[0]=0,p.axes[1]=0,p.axes[2]=0},30),p.axes[0]=e.movementX,p.axes[1]=e.movementY,p.position[0]=e.clientX,p.position[1]=e.clientY},Se=e=>{I.buttons[e.button]={pressed:!0,justPressed:!0,justReleased:!1}},ve=e=>{I.buttons[e.button]={pressed:!1,justPressed:!1,justReleased:!0}},Ee=e=>{p.axes[2]=e.deltaY,globalThis.requestAnimationFrame&&requestAnimationFrame(()=>{p.axes[2]=0})};var Ue=null,Qe=null,Ve=null,He=null,qe=null,Ie=null,_e=null,Xe=null,Ce=!1,ze=()=>{ee(),te()},Ye=e=>(typeof window>"u"||(Ce||(Je(),ze(),Ce=!0),Ke(),ce(),ae()),e);var Je=()=>{Ue=window.addEventListener("mousemove",xe),Qe=window.addEventListener("mousedown",Se),Ve=window.addEventListener("mouseup",ve),He=window.addEventListener("mousewheel",Ee),qe=window.addEventListener("keydown",me),Ie=window.addEventListener("keyup",ye),_e=window.addEventListener("gamepadconnected",de),Xe=window.addEventListener("gamepaddisconnected",ue)};var Ze={...ge(),...we(),...ie()};var _=e=>{let t=document.createElement("canvas"),{target:a,fullscreen:y}=e,{body:w}=window.document;a&&y?e.target=null:!a&&!y&&(e.fullscreen=!0),y&&(Object.assign(t.style,{position:"absolute",top:"0",left:"0"}),t.width=window.innerWidth,t.height=window.innerHeight,w.appendChild(t),Object.assign(w.style,{margin:"0",padding:"0",width:"100%",height:"100%",overflow:"hidden"})),a&&(a.appendChild(t),a.style.overflow="hidden",t.width=t.offsetWidth,t.height=t.offsetHeight),t.width=t.offsetWidth,t.height=t.offsetHeight,t.style.width="100%",t.style.height="100%";let o=window.document.querySelector('meta[name="viewport"]');if(o)Object.assign(o,{content:"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"});else{let l=Object.assign(window.document.createElement("meta"),{name:"viewport",content:"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"});window.document.head.appendChild(l)}return t};var Me=e=>~~(.5+e),F=e=>({x:Me(e.x),y:Me(e.y)}),X=e=>({text:(o,l,E="gray",K=16)=>{o=F(o),e.save(),e.fillStyle=E,e.font=`${K}px sans-serif`,e.fillText(l,o.x,o.y),e.restore()},line:(o,l,E="gray",K=1)=>{o=F(o),l=F(l),e.save(),e.beginPath(),e.moveTo(o.x,o.y),e.lineTo(l.x,l.y),e.lineWidth=K,e.stroke(),e.closePath(),e.restore()},rectangle:(o,l,E="gray",K=1)=>{o=F(o),l=F(l),e.save(),e.beginPath(),e.rect(o.x,o.y,l.x,l.y),e.lineWidth=K,e.strokeStyle=E,e.stroke(),e.closePath(),e.restore()},circle:(o,l=25,E="gray",K=1)=>{o=F(o),e.save(),e.beginPath(),e.strokeStyle=E,e.lineWidth=K,e.arc(o.x,o.y,l,0,Math.PI*2,!0),e.stroke(),e.closePath(),e.restore()}});var ke=e=>{let{width:t=800,height:a=600,fullscreen:y=!1,target:w=null}=e.canvas,o=_({width:t,height:a,fullscreen:y,target:w}),l=o.getContext("2d"),E=X(l),K=()=>{if(y){o.style.width="100%",o.style.height="100%",o.width=window.innerWidth,o.height=window.innerHeight;return}o.width=o.offsetWidth,o.height=o.offsetHeight};return window.addEventListener("resize",K),{canvas:o,context:l,draw:E,destroy:()=>{window.removeEventListener("resize",K),o.parentElement.removeChild(o)}}};var et=256,tt=(e={maxLifetime:1e4})=>{let t={expiringLogs:[],allLogs:[],update(a){this.expiringLogs.length&&this.expiringLogs.forEach((y,w)=>{y.lifetime-=a.time.delta,y.lifetime<0&&this.expiringLogs.splice(w,1)})},log(a){this.expiringLogs.push({message:a,lifetime:e.maxLifetime,start:new Date}),this.allLogs.push({message:a})}};return t.update=t.update.bind(t),t.log=t.log.bind(t),t.allLogs.push=function(){return this.length>=et&&this.shift(),Array.prototype.push.apply(this,arguments)},t};export{ke as create2D,_ as createCanvas,X as createDraw,tt as createLogSystem,$e as createWorld,Ze as input,Ye as inputSystem};
